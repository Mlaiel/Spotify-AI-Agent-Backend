# ðŸš€ Spotify AI Agent - Data Isolation Core Makefile
# ================================================
# 
# Automatisation des tÃ¢ches pour le module core d'isolation des donnÃ©es
# 
# Author: Lead Dev + Architecte IA - Fahed Mlaiel

.PHONY: help install test benchmark validate monitor migrate clean format lint security

# Variables
PYTHON := python3
PIP := pip3
CORE_DIR := /workspaces/Achiri/spotify-ai-agent/backend/app/tenancy/data_isolation/core
VENV_DIR := $(CORE_DIR)/venv

# Couleurs pour l'affichage
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
PURPLE := \033[0;35m
CYAN := \033[0;36m
NC := \033[0m # No Color

# Aide par dÃ©faut
help: ## ðŸ“š Affiche cette aide
	@echo "$(CYAN)ðŸŽµ Spotify AI Agent - Data Isolation Core$(NC)"
	@echo "$(CYAN)===============================================$(NC)"
	@echo ""
	@echo "$(GREEN)ðŸ“‹ Commandes disponibles:$(NC)"
	@echo ""
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(GREEN)ðŸ”§ Variables d'environnement importantes:$(NC)"
	@echo "  TENANT_ISOLATION_LEVEL    Niveau d'isolation (basic/strict/paranoid)"
	@echo "  CACHE_SIZE_MB            Taille du cache en MB"
	@echo "  SECURITY_PARANOID_MODE   Mode sÃ©curitÃ© renforcÃ©e (true/false)"
	@echo ""

# Installation et configuration
install: ## ðŸ”§ Installe les dÃ©pendances et configure l'environnement
	@echo "$(BLUE)ðŸ”§ Installation des dÃ©pendances...$(NC)"
	$(PIP) install -r $(CORE_DIR)/../../../requirements.txt
	$(PIP) install psutil aioredis
	@echo "$(GREEN)âœ… Installation terminÃ©e$(NC)"

install-dev: ## ðŸ› ï¸ Installe les dÃ©pendances de dÃ©veloppement
	@echo "$(BLUE)ðŸ› ï¸ Installation des dÃ©pendances de dÃ©veloppement...$(NC)"
	$(PIP) install pytest pytest-asyncio pytest-cov black flake8 mypy
	@echo "$(GREEN)âœ… Installation dev terminÃ©e$(NC)"

# Tests et validation
test: ## ðŸ§ª Execute les tests unitaires
	@echo "$(BLUE)ðŸ§ª ExÃ©cution des tests...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) -m pytest ../../../tests/tenancy/data_isolation/core/ -v
	@echo "$(GREEN)âœ… Tests terminÃ©s$(NC)"

test-coverage: ## ðŸ“Š Execute les tests avec couverture de code
	@echo "$(BLUE)ðŸ“Š Tests avec couverture...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) -m pytest ../../../tests/tenancy/data_isolation/core/ --cov=. --cov-report=html --cov-report=term
	@echo "$(GREEN)âœ… Rapport de couverture gÃ©nÃ©rÃ©$(NC)"

benchmark: ## âš¡ Execute le benchmark de performance
	@echo "$(BLUE)âš¡ Benchmark de performance...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) benchmark_performance.py --output benchmark_report.md
	@echo "$(GREEN)âœ… Benchmark terminÃ© - Voir benchmark_report.md$(NC)"

benchmark-quick: ## ðŸš€ Execute un benchmark rapide
	@echo "$(BLUE)ðŸš€ Benchmark rapide...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) benchmark_performance.py --quick
	@echo "$(GREEN)âœ… Benchmark rapide terminÃ©$(NC)"

validate: ## ðŸ” Valide la configuration du systÃ¨me
	@echo "$(BLUE)ðŸ” Validation de la configuration...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) validate_configuration.py --output validation_report.md
	@echo "$(GREEN)âœ… Validation terminÃ©e - Voir validation_report.md$(NC)"

validate-json: ## ðŸ“„ Valide la configuration (sortie JSON)
	@echo "$(BLUE)ðŸ“„ Validation JSON...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) validate_configuration.py --json --output validation_results.json
	@echo "$(GREEN)âœ… Validation JSON terminÃ©e$(NC)"

# Monitoring et observabilitÃ©
monitor: ## ðŸ“Š Lance le monitoring en temps rÃ©el
	@echo "$(BLUE)ðŸ“Š DÃ©marrage du monitoring en temps rÃ©el...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) monitor_realtime.py

monitor-export: ## ðŸ“ Lance le monitoring avec export automatique
	@echo "$(BLUE)ðŸ“ Monitoring avec export...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) monitor_realtime.py --export monitoring_metrics_$$(date +%Y%m%d_%H%M%S).json

# Migrations
migrate-status: ## ðŸ“‹ Affiche le statut des migrations
	@echo "$(BLUE)ðŸ“‹ Statut des migrations...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) migrate_isolation.py status

migrate-up: ## â¬†ï¸ Applique toutes les migrations en attente
	@echo "$(BLUE)â¬†ï¸ Application des migrations...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) migrate_isolation.py up
	@echo "$(GREEN)âœ… Migrations appliquÃ©es$(NC)"

migrate-down: ## â¬‡ï¸ Annule la derniÃ¨re migration
	@echo "$(YELLOW)â¬‡ï¸ Annulation de la derniÃ¨re migration...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) migrate_isolation.py down --steps 1
	@echo "$(GREEN)âœ… Migration annulÃ©e$(NC)"

migrate-validate: ## âœ… Valide les migrations en attente
	@echo "$(BLUE)âœ… Validation des migrations...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) migrate_isolation.py validate

migrate-dry-run: ## ðŸ§ª Simule les migrations sans les appliquer
	@echo "$(BLUE)ðŸ§ª Simulation des migrations...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) migrate_isolation.py up --dry-run

# QualitÃ© du code
format: ## ðŸŽ¨ Formate le code avec Black
	@echo "$(BLUE)ðŸŽ¨ Formatage du code...$(NC)"
	black $(CORE_DIR)/*.py
	@echo "$(GREEN)âœ… Code formatÃ©$(NC)"

lint: ## ðŸ” Analyse le code avec Flake8
	@echo "$(BLUE)ðŸ” Analyse du code...$(NC)"
	flake8 $(CORE_DIR)/*.py --max-line-length=120 --ignore=E203,W503
	@echo "$(GREEN)âœ… Analyse terminÃ©e$(NC)"

type-check: ## ðŸ”¬ VÃ©rification des types avec MyPy
	@echo "$(BLUE)ðŸ”¬ VÃ©rification des types...$(NC)"
	mypy $(CORE_DIR)/*.py --ignore-missing-imports
	@echo "$(GREEN)âœ… Types vÃ©rifiÃ©s$(NC)"

# SÃ©curitÃ©
security-scan: ## ðŸ›¡ï¸ Scan de sÃ©curitÃ© avec Bandit
	@echo "$(BLUE)ðŸ›¡ï¸ Scan de sÃ©curitÃ©...$(NC)"
	bandit -r $(CORE_DIR)/ -f json -o security_report.json
	@echo "$(GREEN)âœ… Scan de sÃ©curitÃ© terminÃ©$(NC)"

check-deps: ## ðŸ”’ VÃ©rifie les vulnÃ©rabilitÃ©s des dÃ©pendances
	@echo "$(BLUE)ðŸ”’ VÃ©rification des dÃ©pendances...$(NC)"
	safety check
	@echo "$(GREEN)âœ… DÃ©pendances vÃ©rifiÃ©es$(NC)"

# Documentation
docs: ## ðŸ“š GÃ©nÃ¨re la documentation
	@echo "$(BLUE)ðŸ“š GÃ©nÃ©ration de la documentation...$(NC)"
	# Ici vous pouvez ajouter Sphinx ou autre gÃ©nÃ©rateur de docs
	@echo "$(GREEN)âœ… Documentation gÃ©nÃ©rÃ©e$(NC)"

# Nettoyage
clean: ## ðŸ§¹ Nettoie les fichiers temporaires
	@echo "$(BLUE)ðŸ§¹ Nettoyage des fichiers temporaires...$(NC)"
	find $(CORE_DIR) -type f -name "*.pyc" -delete
	find $(CORE_DIR) -type d -name "__pycache__" -delete
	rm -f $(CORE_DIR)/*.log
	rm -f $(CORE_DIR)/benchmark_report.md
	rm -f $(CORE_DIR)/validation_report.md
	rm -f $(CORE_DIR)/validation_results.json
	rm -f $(CORE_DIR)/monitoring_metrics_*.json
	rm -f $(CORE_DIR)/security_report.json
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

clean-cache: ## ðŸ—‘ï¸ Nettoie le cache de performance
	@echo "$(BLUE)ðŸ—‘ï¸ Nettoyage du cache...$(NC)"
	# Simulation du nettoyage de cache
	@echo "$(GREEN)âœ… Cache nettoyÃ©$(NC)"

# DÃ©veloppement
dev-setup: install install-dev ## ðŸ—ï¸ Configuration complÃ¨te pour le dÃ©veloppement
	@echo "$(GREEN)ðŸ—ï¸ Environnement de dÃ©veloppement configurÃ©$(NC)"

pre-commit: format lint type-check test ## ðŸš€ VÃ©rifie la qualitÃ© avant commit
	@echo "$(GREEN)ðŸš€ Code prÃªt pour commit$(NC)"

ci: format lint type-check test benchmark validate ## ðŸ”„ Pipeline CI complet
	@echo "$(GREEN)ðŸ”„ Pipeline CI terminÃ© avec succÃ¨s$(NC)"

# DÃ©ploiement
deploy-check: validate benchmark security-scan ## ðŸš VÃ©rifications avant dÃ©ploiement
	@echo "$(GREEN)ðŸš VÃ©rifications de dÃ©ploiement terminÃ©es$(NC)"

# Maintenance
health-check: ## ðŸ’Š VÃ©rification de santÃ© du systÃ¨me
	@echo "$(BLUE)ðŸ’Š VÃ©rification de santÃ©...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) validate_configuration.py --json | jq '.summary.overall_status'
	@echo "$(GREEN)âœ… VÃ©rification de santÃ© terminÃ©e$(NC)"

performance-report: ## ðŸ“ˆ GÃ©nÃ¨re un rapport de performance dÃ©taillÃ©
	@echo "$(BLUE)ðŸ“ˆ GÃ©nÃ©ration du rapport de performance...$(NC)"
	cd $(CORE_DIR) && $(PYTHON) benchmark_performance.py --output performance_report_$$(date +%Y%m%d).md
	@echo "$(GREEN)âœ… Rapport de performance gÃ©nÃ©rÃ©$(NC)"

# Configuration d'exemple
create-env-example: ## ðŸ“ CrÃ©e un fichier d'exemple de variables d'environnement
	@echo "$(BLUE)ðŸ“ CrÃ©ation du fichier .env.example...$(NC)"
	@cat > $(CORE_DIR)/.env.example << 'EOF'
# ðŸŽµ Spotify AI Agent - Data Isolation Core Configuration
# =====================================================

# Isolation Configuration
TENANT_ISOLATION_LEVEL=strict
PERFORMANCE_OPTIMIZATION=adaptive

# Cache Configuration
CACHE_SIZE_MB=2048
CACHE_TTL_SECONDS=300
QUERY_CACHE_ENABLED=true

# Security Configuration
SECURITY_PARANOID_MODE=true
ENCRYPTION_KEY_VERSION=2
MFA_ENFORCEMENT=true

# Compliance Configuration
COMPLIANCE_AUDIT_ENABLED=true
GDPR_STRICT_MODE=true
AUDIT_RETENTION_DAYS=2555

# Monitoring Configuration
METRICS_COLLECTION_ENABLED=true
ALERTING_ENABLED=true
LOG_LEVEL=INFO

# Database Configuration
DB_CONNECTION_POOL_SIZE=20
DB_QUERY_TIMEOUT=30
DB_CONNECTION_TIMEOUT=10

# Performance Tuning
CONTEXT_SWITCH_OPTIMIZATION=true
QUERY_OPTIMIZATION_ENABLED=true
BACKGROUND_TASKS_ENABLED=true
EOF
	@echo "$(GREEN)âœ… Fichier .env.example crÃ©Ã©$(NC)"

# Informations systÃ¨me
system-info: ## â„¹ï¸ Affiche les informations systÃ¨me
	@echo "$(CYAN)â„¹ï¸ Informations SystÃ¨me$(NC)"
	@echo "$(CYAN)========================$(NC)"
	@echo "Python: $$($(PYTHON) --version)"
	@echo "Pip: $$($(PIP) --version)"
	@echo "SystÃ¨me: $$(uname -a)"
	@echo "Espace disque: $$(df -h . | tail -1 | awk '{print $$4}') disponible"
	@echo "MÃ©moire: $$(free -h | grep Mem | awk '{print $$7}') disponible"

# Raccourcis utiles
quick-test: benchmark-quick validate ## âš¡ Tests rapides (benchmark + validation)
	@echo "$(GREEN)âš¡ Tests rapides terminÃ©s$(NC)"

full-check: ci deploy-check ## ðŸŽ¯ VÃ©rification complÃ¨te
	@echo "$(GREEN)ðŸŽ¯ VÃ©rification complÃ¨te terminÃ©e$(NC)"

# Meta
version: ## ðŸ“Œ Affiche la version du module
	@echo "$(CYAN)Data Isolation Core Module v2.0.0$(NC)"
	@echo "$(CYAN)Author: Lead Dev + Architecte IA - Fahed Mlaiel$(NC)"

update-scripts: ## ðŸ”„ Met Ã  jour les permissions des scripts
	chmod +x $(CORE_DIR)/*.py
	@echo "$(GREEN)âœ… Permissions des scripts mises Ã  jour$(NC)"
