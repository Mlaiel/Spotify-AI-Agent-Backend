# Makefile pour les SchÃ©mas Spotify AI Agent
# Automatisation des tÃ¢ches de dÃ©veloppement et dÃ©ploiement

.PHONY: help setup validate test docs openapi metrics build deploy clean monitor status install dev-setup

# Configuration
PYTHON := python3
PIP := pip3
SCHEMA_DIR := .
SCRIPTS_DIR := scripts

# Couleurs pour l'affichage
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m

# Cible par dÃ©faut
help:
	@echo "$(BLUE)ğŸ¯ Spotify AI Agent - SchÃ©mas Management$(NC)"
	@echo ""
	@echo "$(GREEN)Commandes disponibles:$(NC)"
	@echo "  $(YELLOW)setup$(NC)       - Configuration initiale de l'environnement"
	@echo "  $(YELLOW)install$(NC)     - Installation des dÃ©pendances Python"
	@echo "  $(YELLOW)validate$(NC)    - Validation de tous les schÃ©mas"
	@echo "  $(YELLOW)test$(NC)        - ExÃ©cution des tests complets"
	@echo "  $(YELLOW)docs$(NC)        - GÃ©nÃ©ration de la documentation"
	@echo "  $(YELLOW)openapi$(NC)     - Export de la spÃ©cification OpenAPI"
	@echo "  $(YELLOW)metrics$(NC)     - Analyse des mÃ©triques des schÃ©mas"
	@echo "  $(YELLOW)build$(NC)       - Construction du package complet"
	@echo "  $(YELLOW)deploy$(NC)      - DÃ©ploiement des schÃ©mas"
	@echo "  $(YELLOW)clean$(NC)       - Nettoyage des fichiers temporaires"
	@echo "  $(YELLOW)monitor$(NC)     - Monitoring continu des schÃ©mas"
	@echo "  $(YELLOW)status$(NC)      - Affichage de l'Ã©tat du systÃ¨me"
	@echo "  $(YELLOW)dev-setup$(NC)   - Configuration pour dÃ©veloppement"
	@echo ""
	@echo "$(GREEN)Exemples:$(NC)"
	@echo "  make setup && make validate  # Installation et validation"
	@echo "  make build                   # Build complet"
	@echo "  make deploy                  # DÃ©ploiement en production"

# Configuration initiale
setup:
	@echo "$(BLUE)ğŸ”§ Configuration de l'environnement...$(NC)"
	@mkdir -p docs dist tests logs
	@$(SCRIPTS_DIR)/deploy.sh setup
	@echo "$(GREEN)âœ… Environnement configurÃ©$(NC)"

# Installation des dÃ©pendances
install:
	@echo "$(BLUE)ğŸ“¦ Installation des dÃ©pendances...$(NC)"
	@$(PIP) install --upgrade pip
	@$(PIP) install pydantic typing_extensions email_validator
	@$(PIP) install jinja2 asyncio pathlib
	@echo "$(GREEN)âœ… DÃ©pendances installÃ©es$(NC)"

# Configuration pour dÃ©veloppement
dev-setup: install
	@echo "$(BLUE)ğŸ› ï¸ Configuration dÃ©veloppement...$(NC)"
	@$(PIP) install pytest pytest-asyncio black flake8 mypy
	@$(PIP) install jupyter notebook ipython
	@echo "$(GREEN)âœ… Environnement de dÃ©veloppement prÃªt$(NC)"

# Validation des schÃ©mas
validate:
	@echo "$(BLUE)ğŸ” Validation des schÃ©mas...$(NC)"
	@$(PYTHON) $(SCRIPTS_DIR)/validate_schemas.py validate
	@echo "$(GREEN)âœ… Validation terminÃ©e$(NC)"

# Tests complets
test: validate
	@echo "$(BLUE)ğŸ§ª ExÃ©cution des tests...$(NC)"
	@$(SCRIPTS_DIR)/deploy.sh test
	@echo "$(GREEN)âœ… Tests terminÃ©s$(NC)"

# GÃ©nÃ©ration de documentation
docs:
	@echo "$(BLUE)ğŸ“š GÃ©nÃ©ration de la documentation...$(NC)"
	@$(PYTHON) $(SCRIPTS_DIR)/validate_schemas.py docs --output docs/
	@echo "$(GREEN)âœ… Documentation gÃ©nÃ©rÃ©e dans docs/$(NC)"

# Export OpenAPI
openapi:
	@echo "$(BLUE)ğŸ“‹ Export OpenAPI...$(NC)"
	@$(PYTHON) $(SCRIPTS_DIR)/validate_schemas.py openapi --output openapi.json
	@echo "$(GREEN)âœ… SpÃ©cification OpenAPI exportÃ©e$(NC)"

# Analyse des mÃ©triques
metrics:
	@echo "$(BLUE)ğŸ“Š Analyse des mÃ©triques...$(NC)"
	@$(PYTHON) $(SCRIPTS_DIR)/validate_schemas.py metrics --output metrics_report.json
	@echo "$(GREEN)âœ… Rapport de mÃ©triques gÃ©nÃ©rÃ©$(NC)"

# Build complet
build: clean validate docs openapi metrics
	@echo "$(BLUE)ğŸš€ Construction du package...$(NC)"
	@$(SCRIPTS_DIR)/deploy.sh build
	@echo "$(GREEN)âœ… Package construit avec succÃ¨s$(NC)"

# DÃ©ploiement
deploy: build
	@echo "$(BLUE)ğŸš€ DÃ©ploiement...$(NC)"
	@$(SCRIPTS_DIR)/deploy.sh deploy
	@echo "$(GREEN)âœ… DÃ©ploiement terminÃ©$(NC)"

# Nettoyage
clean:
	@echo "$(BLUE)ğŸ§¹ Nettoyage...$(NC)"
	@find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@find . -name "*.pyc" -delete 2>/dev/null || true
	@find . -name "*.pyo" -delete 2>/dev/null || true
	@find . -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null || true
	@rm -rf dist/*.tar.gz 2>/dev/null || true
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

# Monitoring continu
monitor:
	@echo "$(BLUE)ğŸ‘ï¸ DÃ©marrage du monitoring...$(NC)"
	@$(SCRIPTS_DIR)/deploy.sh monitor

# Statut du systÃ¨me
status:
	@echo "$(BLUE)ğŸ“Š Ã‰tat du systÃ¨me:$(NC)"
	@$(SCRIPTS_DIR)/deploy.sh status

# Formatage du code
format:
	@echo "$(BLUE)âœ¨ Formatage du code...$(NC)"
	@black . --line-length 88
	@echo "$(GREEN)âœ… Code formatÃ©$(NC)"

# VÃ©rification du style
lint:
	@echo "$(BLUE)ğŸ” VÃ©rification du style...$(NC)"
	@flake8 . --max-line-length=88 --extend-ignore=E203,W503
	@echo "$(GREEN)âœ… Style vÃ©rifiÃ©$(NC)"

# VÃ©rification des types
typecheck:
	@echo "$(BLUE)ğŸ” VÃ©rification des types...$(NC)"
	@mypy . --ignore-missing-imports
	@echo "$(GREEN)âœ… Types vÃ©rifiÃ©s$(NC)"

# VÃ©rifications complÃ¨tes
check: lint typecheck validate
	@echo "$(GREEN)âœ… Toutes les vÃ©rifications passÃ©es$(NC)"

# Installation en mode dÃ©veloppement
dev-install: dev-setup
	@echo "$(BLUE)ğŸ”§ Installation en mode dÃ©veloppement...$(NC)"
	@$(PIP) install -e .
	@echo "$(GREEN)âœ… Installation dÃ©veloppement terminÃ©e$(NC)"

# Tests de performance
perf-test:
	@echo "$(BLUE)âš¡ Tests de performance...$(NC)"
	@$(PYTHON) -c "
import time
from schemas import create_sample_alert, create_sample_notification, create_sample_ml_model

print('ğŸš€ Tests de performance des schÃ©mas')
print('=' * 50)

# Test crÃ©ation d'alertes
start = time.time()
alerts = [create_sample_alert() for _ in range(1000)]
end = time.time()
print(f'CrÃ©ation 1000 alertes: {end-start:.3f}s ({1000/(end-start):.0f}/sec)')

# Test sÃ©rialisation
start = time.time()
json_data = [alert.json() for alert in alerts[:100]]
end = time.time()
print(f'SÃ©rialisation 100 alertes: {end-start:.3f}s ({100/(end-start):.0f}/sec)')

# Test validation
start = time.time()
for i in range(100):
    alert = create_sample_alert()
    assert alert.is_active == True
end = time.time()
print(f'Validation 100 alertes: {end-start:.3f}s ({100/(end-start):.0f}/sec)')

print('âœ… Tests de performance terminÃ©s')
"

# GÃ©nÃ©ration de rapport complet
report: clean validate docs openapi metrics
	@echo "$(BLUE)ğŸ“‹ GÃ©nÃ©ration du rapport complet...$(NC)"
	@echo "# Rapport SchÃ©mas Spotify AI Agent" > report.md
	@echo "GÃ©nÃ©rÃ© le: $$(date)" >> report.md
	@echo "" >> report.md
	@echo "## Validation" >> report.md
	@$(PYTHON) $(SCRIPTS_DIR)/validate_schemas.py validate >> report.md 2>&1 || true
	@echo "" >> report.md
	@echo "## MÃ©triques" >> report.md
	@cat metrics_report.json >> report.md 2>/dev/null || echo "Pas de mÃ©triques disponibles" >> report.md
	@echo "$(GREEN)âœ… Rapport gÃ©nÃ©rÃ©: report.md$(NC)"

# Sauvegarde
backup:
	@echo "$(BLUE)ğŸ’¾ Sauvegarde des schÃ©mas...$(NC)"
	@tar -czf "backup-schemas-$$(date +%Y%m%d-%H%M%S).tar.gz" \
		--exclude='dist' --exclude='logs' --exclude='__pycache__' \
		--exclude='*.pyc' --exclude='.git' .
	@echo "$(GREEN)âœ… Sauvegarde crÃ©Ã©e$(NC)"

# Restauration depuis backup
restore:
	@echo "$(YELLOW)âš ï¸ Restauration depuis sauvegarde$(NC)"
	@echo "Veuillez spÃ©cifier le fichier: make restore FILE=backup-schemas-YYYYMMDD-HHMMSS.tar.gz"

# Aide dÃ©taillÃ©e
help-detailed:
	@echo "$(BLUE)ğŸ¯ Spotify AI Agent - Guide dÃ©taillÃ© des schÃ©mas$(NC)"
	@echo ""
	@echo "$(GREEN)Structure du projet:$(NC)"
	@echo "  ğŸ“ base/          - SchÃ©mas de base et mixins"
	@echo "  ğŸ“ alerts/        - Gestion des alertes"
	@echo "  ğŸ“ notifications/ - SystÃ¨me de notifications"  
	@echo "  ğŸ“ ml/            - ModÃ¨les IA/ML"
	@echo "  ğŸ“ scripts/       - Scripts utilitaires"
	@echo ""
	@echo "$(GREEN)Workflow recommandÃ©:$(NC)"
	@echo "  1. make setup      # Configuration initiale"
	@echo "  2. make validate   # Validation des schÃ©mas"
	@echo "  3. make test       # Tests complets"
	@echo "  4. make build      # Construction"
	@echo "  5. make deploy     # DÃ©ploiement"
	@echo ""
	@echo "$(GREEN)DÃ©veloppement:$(NC)"
	@echo "  make dev-setup     # Configuration dÃ©veloppement"
	@echo "  make check         # VÃ©rifications complÃ¨tes"
	@echo "  make format        # Formatage du code"
	@echo "  make perf-test     # Tests de performance"

# Cibles pour CI/CD
ci-setup: install

ci-test: validate test

ci-build: build

ci-deploy: deploy

# All-in-one pour dÃ©veloppement rapide
quick: validate docs
	@echo "$(GREEN)âœ… Validation et documentation rapides terminÃ©es$(NC)"

# All-in-one pour production
prod: clean build deploy
	@echo "$(GREEN)âœ… DÃ©ploiement production terminÃ©$(NC)"
